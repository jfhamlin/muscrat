(()=>{var c=null,i=null,r=null,l=null,f=null,t=null,n={},D=null,A=!1,G=new TextDecoder("utf-8"),m=(...o)=>{},x=(o,s,E)=>{c=o,i=s,t=E,r=new Int32Array(c),l=new DataView(c),f=new Uint8Array(c),n={DEBUG_HEAD:(i+t.CONTROL_START+16)/4,DEBUG_TAIL:(i+t.CONTROL_START+20)/4};let e=i+t.METRICS_START;D=new Uint32Array(c,e,t.METRICS_SIZE/4)},M=()=>{let o=Atomics.load(r,n.DEBUG_HEAD),s=Atomics.load(r,n.DEBUG_TAIL);if(o===s)return null;let E=[],e=s,u=0,g=1e3;for(;e!==o&&u<g;){if(t.DEBUG_BUFFER_SIZE-e<t.MESSAGE_HEADER_SIZE){e=0;continue}let S=i+t.DEBUG_BUFFER_START+e,R=l.getUint32(S,!0);if(R===t.PADDING_MAGIC){e=0;continue}if(R!==t.MESSAGE_MAGIC){console.error("[DebugWorker] Corrupted message at position",e),e=(e+1)%t.DEBUG_BUFFER_SIZE;continue}let a=l.getUint32(S+4,!0),T=l.getUint32(S+8,!0);if(a<t.MESSAGE_HEADER_SIZE||a>t.DEBUG_BUFFER_SIZE){console.error("[DebugWorker] Invalid message length:",a),e=(e+1)%t.DEBUG_BUFFER_SIZE;continue}let U=a-t.MESSAGE_HEADER_SIZE,p=S+t.MESSAGE_HEADER_SIZE,I=f.slice(p,p+U),_=G.decode(I);_.endsWith(`
`)&&(_=_.slice(0,-1)),E.push({text:_,timestamp:performance.now(),sequence:T}),e=(e+a)%t.DEBUG_BUFFER_SIZE,u++,D&&(Atomics.add(D,20,1),Atomics.add(D,21,U))}return u>0&&Atomics.store(r,n.DEBUG_TAIL,e),E.length>0?E:null},L=()=>{for(;A;)try{let o=Atomics.load(r,n.DEBUG_HEAD),s=Atomics.load(r,n.DEBUG_TAIL);if(o===s){let e=Atomics.wait(r,n.DEBUG_HEAD,o,100);if(!(e==="ok"||e==="not-equal")){if(e==="timed-out")continue}}let E=M();E&&E.length>0&&self.postMessage({type:"debug",messages:E})}catch(o){console.error("[DebugWorker] Error in wait loop:",o),self.postMessage({type:"error",error:o.message}),Atomics.wait(r,0,r[0],10)}},w=()=>{if(!c){console.error("[DebugWorker] Cannot start - not initialized");return}if(A){console.warn("[DebugWorker] Already running");return}A=!0,L()},b=()=>{A=!1},y=()=>{c&&(Atomics.store(r,n.DEBUG_HEAD,0),Atomics.store(r,n.DEBUG_TAIL,0))};self.addEventListener("message",o=>{let{data:s}=o;try{switch(s.type){case"init":x(s.sharedBuffer,s.ringBufferBase,s.bufferConstants),self.postMessage({type:"initialized"});break;case"start":w();break;case"stop":b();break;case"clear":y();break;default:console.warn("[DebugWorker] Unknown message type:",s.type)}}catch(E){console.error("[DebugWorker] Error:",E),self.postMessage({type:"error",error:E.message})}});m("[DebugWorker] Script loaded");})();

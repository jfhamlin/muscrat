(()=>{var a=null,l=null,n=null,R=null,d=null,t=null,c={},r=null,f=!1,F=(...s)=>{},O=-1,P=(s,o,E)=>{a=s,l=o,t=E,n=new Int32Array(a),R=new DataView(a),d=new Uint8Array(a),c={OUT_HEAD:(l+t.CONTROL_START+8)/4,OUT_TAIL:(l+t.CONTROL_START+12)/4};let e=l+t.METRICS_START;r=new Uint32Array(a,e,t.METRICS_SIZE/4)},G=()=>{let s=Atomics.load(n,c.OUT_HEAD),o=Atomics.load(n,c.OUT_TAIL),E=[];if(s===o)return E;let e=o,I=0,u=100;for(;e!==s&&I<u;){if(t.OUT_BUFFER_SIZE-e<t.MESSAGE_HEADER_SIZE){e=0;continue}let A=l+t.OUT_BUFFER_START+e,C=R.getUint32(A,!0);if(C===t.PADDING_MAGIC){e=0;continue}if(C!==t.MESSAGE_MAGIC){console.error("[OSCInWorker] Corrupted message at position",e),r&&Atomics.add(r,18,1),e=(e+1)%t.OUT_BUFFER_SIZE;continue}let i=R.getUint32(A+4,!0),_=R.getUint32(A+8,!0);if(i<t.MESSAGE_HEADER_SIZE||i>t.OUT_BUFFER_SIZE){console.error("[OSCInWorker] Invalid message length:",i),r&&Atomics.add(r,18,1),e=(e+1)%t.OUT_BUFFER_SIZE;continue}if(O>=0){let S=O+1&4294967295;if(_!==S){let T=_-S+4294967296&4294967295;T<1e3&&(console.warn("[OSCInWorker] Detected",T,"dropped messages (expected seq",S,"got",_,")"),r&&Atomics.add(r,18,T))}}O=_;let p=i-t.MESSAGE_HEADER_SIZE,g=A+t.MESSAGE_HEADER_SIZE,U=new Uint8Array(p);for(let S=0;S<p;S++)U[S]=d[g+S];E.push({oscData:U,sequence:_}),e=(e+i)%t.OUT_BUFFER_SIZE,I++,r&&(Atomics.add(r,17,1),Atomics.add(r,19,p))}return I>0&&Atomics.store(n,c.OUT_TAIL,e),E},L=()=>{for(;f;)try{let s=Atomics.load(n,c.OUT_HEAD),o=Atomics.load(n,c.OUT_TAIL);if(s===o){let e=Atomics.wait(n,c.OUT_HEAD,s,100);if(!(e==="ok"||e==="not-equal")){if(e==="timed-out")continue}}let E=G();E.length>0&&self.postMessage({type:"messages",messages:E})}catch(s){console.error("[OSCInWorker] Error in wait loop:",s),self.postMessage({type:"error",error:s.message}),Atomics.wait(n,0,n[0],10)}},N=()=>{if(!a){console.error("[OSCInWorker] Cannot start - not initialized");return}if(f){console.warn("[OSCInWorker] Already running");return}f=!0,L()},w=()=>{f=!1};self.addEventListener("message",s=>{let{data:o}=s;try{switch(o.type){case"init":P(o.sharedBuffer,o.ringBufferBase,o.bufferConstants),self.postMessage({type:"initialized"});break;case"start":N();break;case"stop":w();break;default:console.warn("[OSCInWorker] Unknown message type:",o.type)}}catch(E){console.error("[OSCInWorker] Error:",E),self.postMessage({type:"error",error:E.message})}});F("[OSCInWorker] Script loaded");})();

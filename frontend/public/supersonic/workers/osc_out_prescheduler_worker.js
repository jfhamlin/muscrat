(()=>{function J(e,t,s=0){for(let r=0;r<=s;r++)if(Atomics.compareExchange(e,t,0,1)===0)return!0;return!1}function ee(e,t){Atomics.store(e,t,0)}function y({atomicView:e,dataView:t,uint8View:s,bufferConstants:r,ringBufferBase:c,controlIndices:i,oscMessage:a,maxSpins:P=0}){let C=a.length,d=r.MESSAGE_HEADER_SIZE+C;if(d>r.IN_BUFFER_SIZE-r.MESSAGE_HEADER_SIZE||!J(e,i.IN_WRITE_LOCK,P))return!1;try{let p=Atomics.load(e,i.IN_HEAD),X=Atomics.load(e,i.IN_TAIL);if((r.IN_BUFFER_SIZE-1-p+X)%r.IN_BUFFER_SIZE<d)return!1;let x=Atomics.add(e,i.IN_SEQUENCE,1),g=r.IN_BUFFER_SIZE-p;if(d>g){let u=new Uint8Array(r.MESSAGE_HEADER_SIZE),R=new DataView(u.buffer);R.setUint32(0,r.MESSAGE_MAGIC,!0),R.setUint32(4,d,!0),R.setUint32(8,x,!0),R.setUint32(12,0,!0);let D=c+r.IN_BUFFER_START+p,U=c+r.IN_BUFFER_START;if(g>=r.MESSAGE_HEADER_SIZE){s.set(u,D);let A=g-r.MESSAGE_HEADER_SIZE;s.set(a.subarray(0,A),D+r.MESSAGE_HEADER_SIZE),s.set(a.subarray(A),U)}else{s.set(u.subarray(0,g),D),s.set(u.subarray(g),U);let A=r.MESSAGE_HEADER_SIZE-g;s.set(a,U+A)}}else{let u=c+r.IN_BUFFER_START+p;t.setUint32(u,r.MESSAGE_MAGIC,!0),t.setUint32(u+4,d,!0),t.setUint32(u+8,x,!0),t.setUint32(u+12,0,!0),s.set(a,u+r.MESSAGE_HEADER_SIZE)}Atomics.load(e,i.IN_HEAD);let $=(p+d)%r.IN_BUFFER_SIZE;return Atomics.store(e,i.IN_HEAD,$),!0}finally{ee(e,i.IN_WRITE_LOCK)}}var f=null,_=null,l=null,N=null,Z=null,b=null,Q={},o=null,n=[],v=null,ce=0,B=!1,E=[],H=5,T=65536,ie=2208988800,q=25,Ee=.2,S=(...e)=>{},z=()=>(performance.timeOrigin+performance.now())/1e3+ie,le=e=>{if(e.length>=16&&e[0]===35){let t=new DataView(e.buffer,e.byteOffset),s=t.getUint32(8,!1),r=t.getUint32(12,!1);return s+r/4294967296}return null};var Se=()=>{if(!f||!l){console.error("[PreScheduler] Cannot init - missing buffer or constants");return}N=new Int32Array(f),Z=new DataView(f),b=new Uint8Array(f),Q={IN_HEAD:(_+l.CONTROL_START+0)/4,IN_TAIL:(_+l.CONTROL_START+4)/4,IN_SEQUENCE:(_+l.CONTROL_START+24)/4,IN_WRITE_LOCK:(_+l.CONTROL_START+40)/4};let e=_+l.METRICS_START;o=new Uint32Array(f,e,l.METRICS_SIZE/4),S("[PreScheduler] SharedArrayBuffer initialized with direct ring buffer writing and metrics")},I=()=>{if(!o)return;Atomics.store(o,6,n.length);let e=n.length,t=Atomics.load(o,7);e>t&&Atomics.store(o,7,e)},h=(e,t)=>{if(!f||!N)return console.error("[PreScheduler] Not initialized for ring buffer writing"),!1;let s=e.length,r=l.MESSAGE_HEADER_SIZE+s;return r>l.IN_BUFFER_SIZE-l.MESSAGE_HEADER_SIZE?(console.error("[PreScheduler] Message too large:",r),!1):y({atomicView:N,dataView:Z,uint8View:b,bufferConstants:l,ringBufferBase:_,controlIndices:Q,oscMessage:e,maxSpins:10})?(o&&Atomics.add(o,8,1),!0):(t||console.warn("[PreScheduler] Ring buffer full, message will be queued for retry"),!1)},m=(e,t)=>{let s=n.length+E.length;if(s>=T){console.error("[PreScheduler] Backpressure: dropping retry ("+s+" pending)"),o&&Atomics.add(o,10,1);return}if(E.push({oscData:e,retryCount:0,context:t||"unknown",queuedAt:performance.now()}),o){Atomics.store(o,15,E.length);let r=Atomics.load(o,16);E.length>r&&Atomics.store(o,16,E.length)}S("[PreScheduler] Queued message for retry:",t,"queue size:",E.length)},ue=()=>{if(E.length===0)return;let e=0;for(;e<E.length;){let t=E[e];if(h(t.oscData,!0))E.splice(e,1),o&&(Atomics.add(o,9,1),Atomics.add(o,14,1),Atomics.store(o,15,E.length)),S("[PreScheduler] Retry succeeded for:",t.context,"after",t.retryCount+1,"attempts");else if(t.retryCount++,o&&Atomics.add(o,14,1),t.retryCount>=H){let r=`Ring buffer full - dropped message after ${H} retries (${t.context})`;console.error("[PreScheduler]",r),E.splice(e,1),o&&(Atomics.add(o,10,1),Atomics.store(o,15,E.length)),self.postMessage({type:"error",error:r})}else e++}},ae=(e,t,s)=>{let r=n.length+E.length;if(r>=T)return console.warn("[PreScheduler] Backpressure: rejecting message ("+r+" pending)"),!1;let c=le(e);if(c===null)return S("[PreScheduler] Non-bundle message, dispatching immediately"),h(e,!1)||m(e,"immediate message"),!0;let i=z(),a=c-i,P={ntpTime:c,seq:ce++,editorId:t||0,runTag:s||"",oscData:e};return fe(P),o&&Atomics.add(o,11,1),I(),S("[PreScheduler] Scheduled bundle:","NTP="+c.toFixed(3),"current="+i.toFixed(3),"wait="+(a*1e3).toFixed(1)+"ms","pending="+n.length),!0},fe=e=>{n.push(e),ge(n.length-1)},_e=()=>n.length>0?n[0]:null,de=()=>{if(n.length===0)return null;let e=n[0],t=n.pop();return n.length>0&&(n[0]=t,Y(0)),e},ge=e=>{for(;e>0;){let t=Math.floor((e-1)/2);if(O(n[e],n[t])>=0)break;W(e,t),e=t}},Y=e=>{let t=n.length;for(;;){let s=2*e+1,r=2*e+2,c=e;if(s<t&&O(n[s],n[c])<0&&(c=s),r<t&&O(n[r],n[c])<0&&(c=r),c===e)break;W(e,c),e=c}},O=(e,t)=>e.ntpTime===t.ntpTime?e.seq-t.seq:e.ntpTime-t.ntpTime,W=(e,t)=>{let s=n[e];n[e]=n[t],n[t]=s},pe=()=>{if(v!==null){console.warn("[PreScheduler] Polling already started");return}S("[PreScheduler] Starting periodic polling (every "+q+"ms)"),K()};var K=()=>{B=!0,ue();let e=z(),t=e+Ee,s=0;for(;n.length>0;){let r=_e();if(r.ntpTime<=t){de(),I();let c=r.ntpTime-e;o&&Atomics.add(o,13,1),S("[PreScheduler] Dispatching bundle:","NTP="+r.ntpTime.toFixed(3),"current="+e.toFixed(3),"early="+(c*1e3).toFixed(1)+"ms","remaining="+n.length),h(r.oscData,!1)||m(r.oscData,"scheduled bundle NTP="+r.ntpTime.toFixed(3)),s++}else break}(s>0||n.length>0||E.length>0)&&S("[PreScheduler] Dispatch cycle complete:","dispatched="+s,"pending="+n.length,"retrying="+E.length),B=!1,v=setTimeout(K,q)},V=e=>{if(n.length===0)return;let t=n.length,s=[];for(let c=0;c<n.length;c++){let i=n[c];e(i)||s.push(i)}let r=t-s.length;r>0&&(n=s,he(),o&&Atomics.add(o,12,r),I(),S("[PreScheduler] Cancelled "+r+" events, "+n.length+" remaining"))},he=()=>{for(let e=Math.floor(n.length/2)-1;e>=0;e--)Y(e)},Re=(e,t)=>{V(s=>s.editorId===e&&s.runTag===t)},Ae=e=>{V(t=>t.editorId===e)},Te=()=>{if(n.length===0)return;let e=n.length;o&&Atomics.add(o,12,e),n=[],I(),S("[PreScheduler] Cancelled all "+e+" events")},me=e=>!e||e.length<8?!1:e[0]===35&&e[1]===98&&e[2]===117&&e[3]===110&&e[4]===100&&e[5]===108&&e[6]===101&&e[7]===0,Ie=e=>{let t=[],s=new DataView(e.buffer,e.byteOffset,e.byteLength),r=16;for(;r<e.length;){let c=s.getInt32(r,!1);if(r+=4,c<=0||r+c>e.length)break;let i=e.slice(r,r+c);for(t.push(i),r+=c;r%4!==0&&r<e.length;)r++}return t},Pe=e=>{if(me(e)){let t=Ie(e);for(let s=0;s<t.length;s++)h(t[s],!1)||m(t[s],"immediate bundle message "+s)}else h(e,!1)||m(e,"immediate message")};self.addEventListener("message",e=>{let{data:t}=e;try{switch(t.type){case"init":f=t.sharedBuffer,_=t.ringBufferBase,l=t.bufferConstants,t.maxPendingMessages&&(T=t.maxPendingMessages),Se(),pe(),S("[OSCPreSchedulerWorker] Initialized with NTP-based scheduling, capacity="+T),self.postMessage({type:"initialized"});break;case"send":ae(t.oscData,t.editorId||0,t.runTag||"");break;case"sendImmediate":Pe(t.oscData);break;case"cancelEditorTag":t.runTag!==void 0&&t.runTag!==null&&t.runTag!==""&&Re(t.editorId||0,t.runTag);break;case"cancelEditor":Ae(t.editorId||0);break;case"cancelAll":Te();break;default:console.warn("[OSCPreSchedulerWorker] Unknown message type:",t.type)}}catch(s){console.error("[OSCPreSchedulerWorker] Error:",s),self.postMessage({type:"error",error:s.message})}});S("[OSCPreSchedulerWorker] Script loaded");})();

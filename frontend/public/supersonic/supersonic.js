var n={},n=n||{};(function(){"use strict";n.SECS_70YRS=2208988800,n.TWO_32=4294967296,n.defaults={metadata:!1,unpackSingleArgs:!0},n.isCommonJS=!!(typeof module<"u"&&module.exports),n.isNode=n.isCommonJS&&typeof window>"u",n.isElectron=!!(typeof process<"u"&&process.versions&&process.versions.electron),n.isBufferEnv=n.isNode||n.isElectron,n.isArray=function(s){return s&&Object.prototype.toString.call(s)==="[object Array]"},n.isTypedArrayView=function(s){return s.buffer&&s.buffer instanceof ArrayBuffer},n.isBuffer=function(s){return n.isBufferEnv&&s instanceof Buffer},n.Long=typeof Long<"u"?Long:void 0,n.TextDecoder=typeof TextDecoder<"u"?new TextDecoder("utf-8"):typeof util<"u"&&typeof(util.TextDecoder!=="undefined")?new util.TextDecoder("utf-8"):void 0,n.TextEncoder=typeof TextEncoder<"u"?new TextEncoder("utf-8"):typeof util<"u"&&typeof(util.TextEncoder!=="undefined")?new util.TextEncoder("utf-8"):void 0,n.dataView=function(s,e,t){return s.buffer?new DataView(s.buffer,e,t):s instanceof ArrayBuffer?new DataView(s,e,t):new DataView(new Uint8Array(s),e,t)},n.byteArray=function(s){if(s instanceof Uint8Array)return s;var e=s.buffer?s.buffer:s;if(!(e instanceof ArrayBuffer)&&(typeof e.length>"u"||typeof e=="string"))throw new Error("Can't wrap a non-array-like object as Uint8Array. Object was: "+JSON.stringify(s,null,2));return new Uint8Array(e)},n.nativeBuffer=function(s){return n.isBufferEnv?n.isBuffer(s)?s:Buffer.from(s.buffer?s:new Uint8Array(s)):n.isTypedArrayView(s)?s:new Uint8Array(s)},n.copyByteArray=function(s,e,t){if(n.isTypedArrayView(s)&&n.isTypedArrayView(e))e.set(s,t);else for(var r=t===void 0?0:t,i=Math.min(e.length-t,s.length),o=0,a=r;o<i;o++,a++)e[a]=s[o];return e},n.readString=function(s,e){for(var t=[],r=e.idx;r<s.byteLength;r++){var i=s.getUint8(r);if(i!==0)t.push(i);else{r++;break}}r=r+3&-4,e.idx=r;var o=n.isBufferEnv?n.readString.withBuffer:n.TextDecoder?n.readString.withTextDecoder:n.readString.raw;return o(t)},n.readString.raw=function(s){for(var e="",t=1e4,r=0;r<s.length;r+=t)e+=String.fromCharCode.apply(null,s.slice(r,r+t));return e},n.readString.withTextDecoder=function(s){var e=new Int8Array(s);return n.TextDecoder.decode(e)},n.readString.withBuffer=function(s){return Buffer.from(s).toString("utf-8")},n.writeString=function(s){var e=n.isBufferEnv?n.writeString.withBuffer:n.TextEncoder?n.writeString.withTextEncoder:null,t=s+"\0",r;e&&(r=e(t));for(var i=e?r.length:t.length,o=i+3&-4,a=new Uint8Array(o),l=0;l<i-1;l++){var c=e?r[l]:t.charCodeAt(l);a[l]=c}return a},n.writeString.withTextEncoder=function(s){return n.TextEncoder.encode(s)},n.writeString.withBuffer=function(s){return Buffer.from(s)},n.readPrimitive=function(s,e,t,r){var i=s[e](r.idx,!1);return r.idx+=t,i},n.writePrimitive=function(s,e,t,r,i){i=i===void 0?0:i;var o;return e?o=new Uint8Array(e.buffer):(o=new Uint8Array(r),e=new DataView(o.buffer)),e[t](i,s,!1),o},n.readInt32=function(s,e){return n.readPrimitive(s,"getInt32",4,e)},n.writeInt32=function(s,e,t){return n.writePrimitive(s,e,"setInt32",4,t)},n.readInt64=function(s,e){var t=n.readPrimitive(s,"getInt32",4,e),r=n.readPrimitive(s,"getInt32",4,e);return n.Long?new n.Long(r,t):{high:t,low:r,unsigned:!1}},n.writeInt64=function(s,e,t){var r=new Uint8Array(8);return r.set(n.writePrimitive(s.high,e,"setInt32",4,t),0),r.set(n.writePrimitive(s.low,e,"setInt32",4,t+4),4),r},n.readFloat32=function(s,e){return n.readPrimitive(s,"getFloat32",4,e)},n.writeFloat32=function(s,e,t){return n.writePrimitive(s,e,"setFloat32",4,t)},n.readFloat64=function(s,e){return n.readPrimitive(s,"getFloat64",8,e)},n.writeFloat64=function(s,e,t){return n.writePrimitive(s,e,"setFloat64",8,t)},n.readChar32=function(s,e){var t=n.readPrimitive(s,"getUint32",4,e);return String.fromCharCode(t)},n.writeChar32=function(s,e,t){var r=s.charCodeAt(0);if(!(r===void 0||r<-1))return n.writePrimitive(r,e,"setUint32",4,t)},n.readBlob=function(s,e){var t=n.readInt32(s,e),r=t+3&-4,i=new Uint8Array(s.buffer,e.idx,t);return e.idx+=r,i},n.writeBlob=function(s){s=n.byteArray(s);var e=s.byteLength,t=e+3&-4,r=4,i=t+r,o=new Uint8Array(i),a=new DataView(o.buffer);return n.writeInt32(e,a),o.set(s,r),o},n.readMIDIBytes=function(s,e){var t=new Uint8Array(s.buffer,e.idx,4);return e.idx+=4,t},n.writeMIDIBytes=function(s){s=n.byteArray(s);var e=new Uint8Array(4);return e.set(s),e},n.readColor=function(s,e){var t=new Uint8Array(s.buffer,e.idx,4),r=t[3]/255;return e.idx+=4,{r:t[0],g:t[1],b:t[2],a:r}},n.writeColor=function(s){var e=Math.round(s.a*255),t=new Uint8Array([s.r,s.g,s.b,e]);return t},n.readTrue=function(){return!0},n.readFalse=function(){return!1},n.readNull=function(){return null},n.readImpulse=function(){return 1},n.readTimeTag=function(s,e){var t=n.readPrimitive(s,"getUint32",4,e),r=n.readPrimitive(s,"getUint32",4,e),i=t===0&&r===1?Date.now():n.ntpToJSTime(t,r);return{raw:[t,r],native:i}},n.writeTimeTag=function(s){var e=s.raw?s.raw:n.jsToNTPTime(s.native),t=new Uint8Array(8),r=new DataView(t.buffer);return n.writeInt32(e[0],r,0),n.writeInt32(e[1],r,4),t},n.timeTag=function(s,e){s=s||0,e=e||Date.now();var t=e/1e3,r=Math.floor(t),i=t-r,o=Math.floor(s),a=s-o,l=i+a;if(l>1){var c=Math.floor(l),u=l-c;o+=c,l=u}var h=r+o+n.SECS_70YRS,f=Math.round(n.TWO_32*l);return{raw:[h,f]}},n.ntpToJSTime=function(s,e){var t=s-n.SECS_70YRS,r=e/n.TWO_32,i=(t+r)*1e3;return i},n.jsToNTPTime=function(s){var e=s/1e3,t=Math.floor(e),r=e-t,i=t+n.SECS_70YRS,o=Math.round(n.TWO_32*r);return[i,o]},n.readArguments=function(s,e,t){var r=n.readString(s,t);if(r.indexOf(",")!==0)throw new Error("A malformed type tag string was found while reading the arguments of an OSC message. String was: "+r," at offset: "+t.idx);var i=r.substring(1).split(""),o=[];return n.readArgumentsIntoArray(o,i,r,s,e,t),o},n.readArgument=function(s,e,t,r,i){var o=n.argumentTypes[s];if(!o)throw new Error("'"+s+"' is not a valid OSC type tag. Type tag string was: "+e);var a=o.reader,l=n[a](t,i);return r.metadata&&(l={type:s,value:l}),l},n.readArgumentsIntoArray=function(s,e,t,r,i,o){for(var a=0;a<e.length;){var l=e[a],c;if(l==="["){var u=e.slice(a+1),h=u.indexOf("]");if(h<0)throw new Error("Invalid argument type tag: an open array type tag ('[') was found without a matching close array tag ('[]'). Type tag was: "+t);var f=u.slice(0,h);c=n.readArgumentsIntoArray([],f,t,r,i,o),a+=h+2}else c=n.readArgument(l,t,r,i,o),a++;s.push(c)}return s},n.writeArguments=function(s,e){var t=n.collectArguments(s,e);return n.joinParts(t)},n.joinParts=function(s){for(var e=new Uint8Array(s.byteLength),t=s.parts,r=0,i=0;i<t.length;i++){var o=t[i];n.copyByteArray(o,e,r),r+=o.length}return e},n.addDataPart=function(s,e){e.parts.push(s),e.byteLength+=s.length},n.writeArrayArguments=function(s,e){for(var t="[",r=0;r<s.length;r++){var i=s[r];t+=n.writeArgument(i,e)}return t+="]",t},n.writeArgument=function(s,e){if(n.isArray(s))return n.writeArrayArguments(s,e);var t=s.type,r=n.argumentTypes[t].writer;if(r){var i=n[r](s.value);n.addDataPart(i,e)}return s.type},n.collectArguments=function(s,e,t){n.isArray(s)||(s=typeof s>"u"?[]:[s]),t=t||{byteLength:0,parts:[]},e.metadata||(s=n.annotateArguments(s));for(var r=",",i=t.parts.length,o=0;o<s.length;o++){var a=s[o];r+=n.writeArgument(a,t)}var l=n.writeString(r);return t.byteLength+=l.byteLength,t.parts.splice(i,0,l),t},n.readMessage=function(s,e,t){e=e||n.defaults;var r=n.dataView(s,s.byteOffset,s.byteLength);t=t||{idx:0};var i=n.readString(r,t);return n.readMessageContents(i,r,e,t)},n.readMessageContents=function(s,e,t,r){if(s.indexOf("/")!==0)throw new Error("A malformed OSC address was found while reading an OSC message. String was: "+s);var i=n.readArguments(e,t,r);return{address:s,args:i.length===1&&t.unpackSingleArgs?i[0]:i}},n.collectMessageParts=function(s,e,t){return t=t||{byteLength:0,parts:[]},n.addDataPart(n.writeString(s.address),t),n.collectArguments(s.args,e,t)},n.writeMessage=function(s,e){if(e=e||n.defaults,!n.isValidMessage(s))throw new Error("An OSC message must contain a valid address. Message was: "+JSON.stringify(s,null,2));var t=n.collectMessageParts(s,e);return n.joinParts(t)},n.isValidMessage=function(s){return s.address&&s.address.indexOf("/")===0},n.readBundle=function(s,e,t){return n.readPacket(s,e,t)},n.collectBundlePackets=function(s,e,t){t=t||{byteLength:0,parts:[]},n.addDataPart(n.writeString("#bundle"),t),n.addDataPart(n.writeTimeTag(s.timeTag),t);for(var r=0;r<s.packets.length;r++){var i=s.packets[r],o=i.address?n.collectMessageParts:n.collectBundlePackets,a=o(i,e);t.byteLength+=a.byteLength,n.addDataPart(n.writeInt32(a.byteLength),t),t.parts=t.parts.concat(a.parts)}return t},n.writeBundle=function(s,e){if(!n.isValidBundle(s))throw new Error("An OSC bundle must contain 'timeTag' and 'packets' properties. Bundle was: "+JSON.stringify(s,null,2));e=e||n.defaults;var t=n.collectBundlePackets(s,e);return n.joinParts(t)},n.isValidBundle=function(s){return s.timeTag!==void 0&&s.packets!==void 0},n.readBundleContents=function(s,e,t,r){for(var i=n.readTimeTag(s,t),o=[];t.idx<r;){var a=n.readInt32(s,t),l=t.idx+a,c=n.readPacket(s,e,t,l);o.push(c)}return{timeTag:i,packets:o}},n.readPacket=function(s,e,t,r){var i=n.dataView(s,s.byteOffset,s.byteLength);r=r===void 0?i.byteLength:r,t=t||{idx:0};var o=n.readString(i,t),a=o[0];if(a==="#")return n.readBundleContents(i,e,t,r);if(a==="/")return n.readMessageContents(o,i,e,t);throw new Error("The header of an OSC packet didn't contain an OSC address or a #bundle string. Header was: "+o)},n.writePacket=function(s,e){if(n.isValidMessage(s))return n.writeMessage(s,e);if(n.isValidBundle(s))return n.writeBundle(s,e);throw new Error("The specified packet was not recognized as a valid OSC message or bundle. Packet was: "+JSON.stringify(s,null,2))},n.argumentTypes={i:{reader:"readInt32",writer:"writeInt32"},h:{reader:"readInt64",writer:"writeInt64"},f:{reader:"readFloat32",writer:"writeFloat32"},s:{reader:"readString",writer:"writeString"},S:{reader:"readString",writer:"writeString"},b:{reader:"readBlob",writer:"writeBlob"},t:{reader:"readTimeTag",writer:"writeTimeTag"},T:{reader:"readTrue"},F:{reader:"readFalse"},N:{reader:"readNull"},I:{reader:"readImpulse"},d:{reader:"readFloat64",writer:"writeFloat64"},c:{reader:"readChar32",writer:"writeChar32"},r:{reader:"readColor",writer:"writeColor"},m:{reader:"readMIDIBytes",writer:"writeMIDIBytes"}},n.inferTypeForArgument=function(s){var e=typeof s;switch(e){case"boolean":return s?"T":"F";case"string":return"s";case"number":return"f";case"undefined":return"N";case"object":if(s===null)return"N";if(s instanceof Uint8Array||s instanceof ArrayBuffer)return"b";if(typeof s.high=="number"&&typeof s.low=="number")return"h";break}throw new Error("Can't infer OSC argument type for value: "+JSON.stringify(s,null,2))},n.annotateArguments=function(s){for(var e=[],t=0;t<s.length;t++){var r=s[t],i;if(typeof r=="object"&&r.type&&r.value!==void 0)i=r;else if(n.isArray(r))i=n.annotateArguments(r);else{var o=n.inferTypeForArgument(r);i={type:o,value:r}}e.push(i)}return e}})();var B=function(){};B.prototype.on=function(){};B.prototype.emit=function(){};B.prototype.removeListener=function(){};(function(){"use strict";n.supportsSerial=!1,n.firePacketEvents=function(e,t,r,i){t.address?e.emit("message",t,r,i):n.fireBundleEvents(e,t,r,i)},n.fireBundleEvents=function(e,t,r,i){e.emit("bundle",t,r,i);for(var o=0;o<t.packets.length;o++){var a=t.packets[o];n.firePacketEvents(e,a,t.timeTag,i)}},n.fireClosedPortSendError=function(e,t){t=t||"Can't send packets on a closed osc.Port object. Please open (or reopen) this Port by calling open().",e.emit("error",t)},n.Port=function(e){this.options=e||{},this.on("data",this.decodeOSC.bind(this))};var s=n.Port.prototype=Object.create(B.prototype);s.constructor=n.Port,s.send=function(e){var t=Array.prototype.slice.call(arguments),r=this.encodeOSC(e),i=n.nativeBuffer(r);t[0]=i,this.sendRaw.apply(this,t)},s.encodeOSC=function(e){e=e.buffer?e.buffer:e;var t;try{t=n.writePacket(e,this.options)}catch(r){this.emit("error",r)}return t},s.decodeOSC=function(e,t){e=n.byteArray(e),this.emit("raw",e,t);try{var r=n.readPacket(e,this.options);this.emit("osc",r,t),n.firePacketEvents(this,r,void 0,t)}catch(i){this.emit("error",i)}},n.SLIPPort=function(e){var t=this,r=this.options=e||{};r.useSLIP=r.useSLIP===void 0?!0:r.useSLIP,this.decoder=new slip.Decoder({onMessage:this.decodeOSC.bind(this),onError:function(o){t.emit("error",o)}});var i=r.useSLIP?this.decodeSLIPData:this.decodeOSC;this.on("data",i.bind(this))},s=n.SLIPPort.prototype=Object.create(n.Port.prototype),s.constructor=n.SLIPPort,s.encodeOSC=function(e){e=e.buffer?e.buffer:e;var t;try{var r=n.writePacket(e,this.options);t=slip.encode(r)}catch(i){this.emit("error",i)}return t},s.decodeSLIPData=function(e,t){this.decoder.decode(e,t)},n.relay=function(e,t,r,i,o,a){r=r||"message",i=i||"send",o=o||function(){},a=a?[null].concat(a):[];var l=function(c){a[0]=c,c=o(c),t[i].apply(t,a)};return e.on(r,l),{eventName:r,listener:l}},n.relayPorts=function(e,t,r){var i=r.raw?"raw":"osc",o=r.raw?"sendRaw":"send";return n.relay(e,t,i,o,r.transform)},n.stopRelaying=function(e,t){e.removeListener(t.eventName,t.listener)},n.Relay=function(e,t,r){var i=this.options=r||{};i.raw=!1,this.port1=e,this.port2=t,this.listen()},s=n.Relay.prototype=Object.create(B.prototype),s.constructor=n.Relay,s.open=function(){this.port1.open(),this.port2.open()},s.listen=function(){this.port1Spec&&this.port2Spec&&this.close(),this.port1Spec=n.relayPorts(this.port1,this.port2,this.options),this.port2Spec=n.relayPorts(this.port2,this.port1,this.options);var e=this.close.bind(this);this.port1.on("close",e),this.port2.on("close",e)},s.close=function(){n.stopRelaying(this.port1,this.port1Spec),n.stopRelaying(this.port2,this.port2Spec),this.emit("close",this.port1,this.port2)}})();(function(){"use strict";n.WebSocket=typeof WebSocket<"u"?WebSocket:void 0,n.WebSocketPort=function(e){n.Port.call(this,e),this.on("open",this.listen.bind(this)),this.socket=e.socket,this.socket&&(this.socket.readyState===1?(n.WebSocketPort.setupSocketForBinary(this.socket),this.emit("open",this.socket)):this.open())};var s=n.WebSocketPort.prototype=Object.create(n.Port.prototype);s.constructor=n.WebSocketPort,s.open=function(){(!this.socket||this.socket.readyState>1)&&(this.socket=new n.WebSocket(this.options.url)),n.WebSocketPort.setupSocketForBinary(this.socket);var e=this;this.socket.onopen=function(){e.emit("open",e.socket)},this.socket.onerror=function(t){e.emit("error",t)}},s.listen=function(){var e=this;this.socket.onmessage=function(t){e.emit("data",t.data,t)},this.socket.onclose=function(t){e.emit("close",t)},e.emit("ready")},s.sendRaw=function(e){if(!this.socket||this.socket.readyState!==1){n.fireClosedPortSendError(this);return}this.socket.send(e)},s.close=function(e,t){this.socket.close(e,t)},n.WebSocketPort.setupSocketForBinary=function(e){e.binaryType=n.isNode?"nodebuffer":"arraybuffer"}})();var R=n,{readPacket:Ze,writePacket:qe,readMessage:Ye,writeMessage:Qe,readBundle:Ke,writeBundle:je}=n;var O=class{constructor(e=null){this.workerBaseURL=e,this.workers={oscOut:null,oscIn:null,debug:null},this.callbacks={onRawOSC:null,onParsedOSC:null,onDebugMessage:null,onError:null,onInitialized:null},this.initialized=!1,this.sharedBuffer=null,this.ringBufferBase=null,this.bufferConstants=null}async init(e,t,r,i={}){if(this.initialized){console.warn("[ScsynthOSC] Already initialized");return}this.sharedBuffer=e,this.ringBufferBase=t,this.bufferConstants=r,this.preschedulerCapacity=i.preschedulerCapacity||65536;try{this.workers.oscOut=new Worker(this.workerBaseURL+"osc_out_prescheduler_worker.js",{type:"module"}),this.workers.oscIn=new Worker(this.workerBaseURL+"osc_in_worker.js",{type:"module"}),this.workers.debug=new Worker(this.workerBaseURL+"debug_worker.js",{type:"module"}),this.setupWorkerHandlers();let o=[this.initWorker(this.workers.oscOut,"OSC SCHEDULER+WRITER",{maxPendingMessages:this.preschedulerCapacity}),this.initWorker(this.workers.oscIn,"OSC IN"),this.initWorker(this.workers.debug,"DEBUG")];await Promise.all(o),this.workers.oscIn.postMessage({type:"start"}),this.workers.debug.postMessage({type:"start"}),this.initialized=!0,this.callbacks.onInitialized&&this.callbacks.onInitialized()}catch(o){throw console.error("[ScsynthOSC] Initialization failed:",o),this.callbacks.onError&&this.callbacks.onError(o),o}}initWorker(e,t,r={}){return new Promise((i,o)=>{let a=setTimeout(()=>{o(new Error(`${t} worker initialization timeout`))},5e3),l=c=>{c.data.type==="initialized"&&(clearTimeout(a),e.removeEventListener("message",l),i())};e.addEventListener("message",l),e.postMessage({type:"init",sharedBuffer:this.sharedBuffer,ringBufferBase:this.ringBufferBase,bufferConstants:this.bufferConstants,...r})})}setupWorkerHandlers(){this.workers.oscIn.onmessage=e=>{let t=e.data;switch(t.type){case"messages":t.messages.forEach(r=>{if(r.oscData&&(this.callbacks.onRawOSC&&this.callbacks.onRawOSC({oscData:r.oscData,sequence:r.sequence}),this.callbacks.onParsedOSC))try{let i={metadata:!1,unpackSingleArgs:!1},o=R.readPacket(r.oscData,i);this.callbacks.onParsedOSC(o)}catch(i){console.error("[ScsynthOSC] Failed to decode OSC message:",i,r)}});break;case"error":console.error("[ScsynthOSC] OSC IN error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"oscIn");break}},this.workers.debug.onmessage=e=>{let t=e.data;switch(t.type){case"debug":this.callbacks.onDebugMessage&&t.messages.forEach(r=>{this.callbacks.onDebugMessage(r)});break;case"error":console.error("[ScsynthOSC] DEBUG error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"debug");break}},this.workers.oscOut.onmessage=e=>{let t=e.data;switch(t.type){case"error":console.error("[ScsynthOSC] OSC OUT error:",t.error),this.callbacks.onError&&this.callbacks.onError(t.error,"oscOut");break}}}send(e,t={}){if(!this.initialized){console.error("[ScsynthOSC] Not initialized");return}let{editorId:r=0,runTag:i="",audioTimeS:o=null,currentTimeS:a=null}=t;this.workers.oscOut.postMessage({type:"send",oscData:e,editorId:r,runTag:i,audioTimeS:o,currentTimeS:a})}sendImmediate(e){if(!this.initialized){console.error("[ScsynthOSC] Not initialized");return}this.workers.oscOut.postMessage({type:"sendImmediate",oscData:e})}cancelEditorTag(e,t){this.initialized&&this.workers.oscOut.postMessage({type:"cancelEditorTag",editorId:e,runTag:t})}cancelEditor(e){this.initialized&&this.workers.oscOut.postMessage({type:"cancelEditor",editorId:e})}cancelAll(){this.initialized&&this.workers.oscOut.postMessage({type:"cancelAll"})}clearDebug(){this.initialized&&this.workers.debug.postMessage({type:"clear"})}onRawOSC(e){this.callbacks.onRawOSC=e}onParsedOSC(e){this.callbacks.onParsedOSC=e}onDebugMessage(e){this.callbacks.onDebugMessage=e}onError(e){this.callbacks.onError=e}onInitialized(e){this.callbacks.onInitialized=e}terminate(){this.workers.oscOut&&(this.workers.oscOut.postMessage({type:"stop"}),this.workers.oscOut.terminate()),this.workers.oscIn&&(this.workers.oscIn.postMessage({type:"stop"}),this.workers.oscIn.terminate()),this.workers.debug&&(this.workers.debug.postMessage({type:"stop"}),this.workers.debug.terminate()),this.workers={oscOut:null,oscIn:null,debug:null},this.initialized=!1}};var ae={5120:"i8",5121:"u8",5122:"i16",5123:"u16",5124:"i32",5125:"u32",5126:"f32"};var z={u8:1,u8c:1,i8:1,u16:2,i16:2,u32:4,i32:4,i64:8,u64:8,f32:4,f64:8};var le={f32:Float32Array,f64:Float64Array},ce={i8:Int8Array,i16:Int16Array,i32:Int32Array},ue={u8:Uint8Array,u8c:Uint8ClampedArray,u16:Uint16Array,u32:Uint32Array},he={i64:BigInt64Array,u64:BigUint64Array},fe={...le,...ce,...ue},de=s=>{let e=ae[s];return e!==void 0?e:s};function $(s,...e){let t=he[s];return new(t||fe[de(s)])(...e)}var I=(s,e)=>(e--,s+e&~e);var W=s=>typeof s=="number";var U=(s,e=t=>t!==void 0?": "+t:"")=>class extends Error{origMessage;constructor(t){super(s(t)+e(t)),this.origMessage=t!==void 0?String(t):""}};var pe=U(()=>"Assertion failed"),D=(typeof process<"u"&&process.env!==void 0?process.env.UMBRELLA_ASSERTS:!import.meta.env||import.meta.env.MODE!=="production"||import.meta.env.UMBRELLA_ASSERTS||import.meta.env.VITE_UMBRELLA_ASSERTS)?(s,e)=>{if(typeof s=="function"&&!s()||!s)throw new pe(typeof e=="function"?e():e)}:()=>{};var Se=U(()=>"illegal argument(s)"),V=s=>{throw new Se(s)};var H=0,G=1,Z=2,q=3,Y=4,b=5,Q=6,P=1,x=2,K=7*4,F=0,N=1,A=2*4,C=class{buf;start;u8;u32;state;constructor(e={}){if(this.buf=e.buf?e.buf:new ArrayBuffer(e.size||4096),this.start=e.start!=null?I(Math.max(e.start,0),4):0,this.u8=new Uint8Array(this.buf),this.u32=new Uint32Array(this.buf),this.state=new Uint32Array(this.buf,this.start,K/4),!e.skipInitialization){let t=e.align||8;D(t>=8,`invalid alignment: ${t}, must be a pow2 and >= 8`);let r=this.initialTop(t),i=e.end!=null?Math.min(e.end,this.buf.byteLength):this.buf.byteLength;r>=i&&V(`insufficient address range (0x${this.start.toString(16)} - 0x${i.toString(16)})`),this.align=t,this.doCompact=e.compact!==!1,this.doSplit=e.split!==!1,this.minSplit=e.minSplit||16,this.end=i,this.top=r,this._free=0,this._used=0}}stats(){let e=r=>{let i=0,o=0;for(;r;)i++,o+=this.blockSize(r),r=this.blockNext(r);return{count:i,size:o}},t=e(this._free);return{free:t,used:e(this._used),top:this.top,available:this.end-this.top+t.size,total:this.buf.byteLength}}callocAs(e,t,r=0){let i=this.mallocAs(e,t);return i?.fill(r),i}mallocAs(e,t){let r=this.malloc(t*z[e]);return r?$(e,this.buf,r,t):void 0}calloc(e,t=0){let r=this.malloc(e);return r&&this.u8.fill(t,r,r+e),r}malloc(e){if(e<=0)return 0;let t=I(e+A,this.align),r=this.end,i=this.top,o=this._free,a=0;for(;o;){let l=this.blockSize(o),c=o+l>=i;if(c||l>=t)return this.mallocTop(o,a,l,t,c);a=o,o=this.blockNext(o)}return o=i,i=o+t,i<=r?(this.initBlock(o,t,this._used),this._used=o,this.top=i,M(o)):0}mallocTop(e,t,r,i,o){if(o&&e+i>this.end)return 0;if(t?this.unlinkBlock(t,e):this._free=this.blockNext(e),this.setBlockNext(e,this._used),this._used=e,o)this.top=e+this.setBlockSize(e,i);else if(this.doSplit){let a=r-i;a>=this.minSplit&&this.splitBlock(e,i,a)}return M(e)}realloc(e,t){if(t<=0)return 0;let r=L(e),i=0,o=this._used,a=0;for(;o;){if(o===r){[i,a]=this.reallocBlock(o,t);break}o=this.blockNext(o)}return i&&i!==r&&this.u8.copyWithin(M(i),M(r),a),M(i)}reallocBlock(e,t){let r=this.blockSize(e),i=e+r,o=i>=this.top,a=I(t+A,this.align);if(a<=r){if(this.doSplit){let l=r-a;l>=this.minSplit?this.splitBlock(e,a,l):o&&(this.top=e+a)}else o&&(this.top=e+a);return[e,i]}return o&&e+a<this.end?(this.top=e+this.setBlockSize(e,a),[e,i]):(this.free(e),[L(this.malloc(t)),i])}reallocArray(e,t){if(e.buffer!==this.buf)return;let r=this.realloc(e.byteOffset,t*e.BYTES_PER_ELEMENT);return r?new e.constructor(this.buf,r,t):void 0}free(e){let t;if(W(e))t=e;else{if(e.buffer!==this.buf)return!1;t=e.byteOffset}t=L(t);let r=this._used,i=0;for(;r;){if(r===t)return i?this.unlinkBlock(i,r):this._used=this.blockNext(r),this.insert(r),this.doCompact&&this.compact(),!0;i=r,r=this.blockNext(r)}return!1}freeAll(){this._free=0,this._used=0,this.top=this.initialTop()}release(){return delete this.u8,delete this.u32,delete this.state,delete this.buf,!0}get align(){return this.state[Y]}set align(e){this.state[Y]=e}get end(){return this.state[q]}set end(e){this.state[q]=e}get top(){return this.state[Z]}set top(e){this.state[Z]=e}get _free(){return this.state[H]}set _free(e){this.state[H]=e}get _used(){return this.state[G]}set _used(e){this.state[G]=e}get doCompact(){return!!(this.state[b]&P)}set doCompact(e){e?this.state[b]|=1<<P-1:this.state[b]&=~P}get doSplit(){return!!(this.state[b]&x)}set doSplit(e){e?this.state[b]|=1<<x-1:this.state[b]&=~x}get minSplit(){return this.state[Q]}set minSplit(e){D(e>A,`illegal min split threshold: ${e}, require at least ${A+1}`),this.state[Q]=e}blockSize(e){return this.u32[(e>>2)+F]}setBlockSize(e,t){return this.u32[(e>>2)+F]=t,t}blockNext(e){return this.u32[(e>>2)+N]}setBlockNext(e,t){this.u32[(e>>2)+N]=t}initBlock(e,t,r){let i=e>>>2;return this.u32[i+F]=t,this.u32[i+N]=r,e}unlinkBlock(e,t){this.setBlockNext(e,this.blockNext(t))}splitBlock(e,t,r){this.insert(this.initBlock(e+this.setBlockSize(e,t),r,0)),this.doCompact&&this.compact()}initialTop(e=this.align){return I(this.start+K+A,e)-A}compact(){let e=this._free,t=0,r=0,i,o=!1;for(;e;){for(i=e,r=this.blockNext(e);r&&i+this.blockSize(i)===r;)i=r,r=this.blockNext(r);if(i!==e){let a=i-e+this.blockSize(i);this.setBlockSize(e,a);let l=this.blockNext(i),c=this.blockNext(e);for(;c&&c!==l;){let u=this.blockNext(c);this.setBlockNext(c,0),c=u}this.setBlockNext(e,l),o=!0}e+this.blockSize(e)>=this.top&&(this.top=e,t?this.unlinkBlock(t,e):this._free=this.blockNext(e)),t=e,e=this.blockNext(e)}return o}insert(e){let t=this._free,r=0;for(;t&&!(e<=t);)r=t,t=this.blockNext(t);r?this.setBlockNext(r,e):this._free=e,this.setBlockNext(e,t)}},M=s=>s>0?s+A:0,L=s=>s>0?s-A:0;var me=8,k=class{#i;#a;#c;#n;#r;#t;#e;#o;constructor(e){let{audioContext:t,sharedBuffer:r,bufferPoolConfig:i,sampleBaseURL:o,maxBuffers:a=1024}=e;if(!t)throw new Error("BufferManager requires audioContext");if(!r||!(r instanceof SharedArrayBuffer))throw new Error("BufferManager requires sharedBuffer (SharedArrayBuffer)");if(!i||typeof i!="object")throw new Error("BufferManager requires bufferPoolConfig (object with start, size, align)");if(!Number.isFinite(i.start)||i.start<0)throw new Error("bufferPoolConfig.start must be a non-negative number");if(!Number.isFinite(i.size)||i.size<=0)throw new Error("bufferPoolConfig.size must be a positive number");if(!Number.isInteger(a)||a<=0)throw new Error("maxBuffers must be a positive integer");this.#a=t,this.#c=r,this.#i=o,this.#n=new C({buf:r,start:i.start,size:i.size,align:me}),this.#r=i.size,this.#t=new Map,this.#e=new Map,this.#o=new Map,this.GUARD_BEFORE=3,this.GUARD_AFTER=1,this.MAX_BUFFERS=a;let l=(i.size/(1024*1024)).toFixed(0),c=(i.start/(1024*1024)).toFixed(0)}#w(e){if(typeof e!="string"||e.length===0)throw new Error("Invalid audio path: must be a non-empty string");if(e.includes(".."))throw new Error(`Invalid audio path: path cannot contain '..' (got: ${e})`);if(e.startsWith("/")||/^[a-zA-Z]:/.test(e))throw new Error(`Invalid audio path: path must be relative (got: ${e})`);if(e.includes("%2e")||e.includes("%2E"))throw new Error(`Invalid audio path: path cannot contain URL-encoded characters (got: ${e})`);if(e.includes("\\"))throw new Error(`Invalid audio path: use forward slashes only (got: ${e})`);if(!this.#i)throw new Error(`sampleBaseURL not configured. Please set it in SuperSonic constructor options.
Example: new SuperSonic({ sampleBaseURL: "./dist/samples/" })
Or use CDN: new SuperSonic({ sampleBaseURL: "https://unpkg.com/supersonic-scsynth-samples@latest/samples/" })
Or install: npm install supersonic-scsynth-samples`);return this.#i+e}#u(e){if(!Number.isInteger(e)||e<0||e>=this.MAX_BUFFERS)throw new Error(`Invalid buffer number ${e} (must be 0-${this.MAX_BUFFERS-1})`)}async#E(e,t,r){let i=null,o=null,a=!1,l=await this.#h(e),c=!1;try{await this.#s(e);let{ptr:u,sizeBytes:h,...f}=await r();i=u;let{uuid:w,allocationComplete:m}=this.#f(e,t);o=w,this.#A(e,i,h,w,m),a=!0;let d=this.#p(e,w,m);return l(),c=!0,{ptr:i,uuid:w,allocationComplete:d,...f}}catch(u){throw a&&o?this.#S(e,o,!1):i&&this.#n.free(i),u}finally{c||l()}}async prepareFromFile(e){let{bufnum:t,path:r,startFrame:i=0,numFrames:o=0,channels:a=null}=e;return this.#u(t),this.#E(t,6e4,async()=>{let l=this.#w(r),c=await fetch(l);if(!c.ok)throw new Error(`Failed to fetch ${l}: ${c.status} ${c.statusText}`);let u=await c.arrayBuffer(),h=await this.#a.decodeAudioData(u),f=Math.max(0,Math.floor(i||0)),w=h.length-f,m=o&&o>0?Math.min(Math.floor(o),w):w;if(m<=0)throw new Error(`No audio frames available for buffer ${t} from ${r}`);let d=this.#g(a,h.numberOfChannels),p=d.length,S=m*p+(this.GUARD_BEFORE+this.GUARD_AFTER)*p,g=this.#y(S),y=new Float32Array(S),_=this.GUARD_BEFORE*p;for(let T=0;T<m;T++)for(let v=0;v<p;v++){let ne=d[v],oe=h.getChannelData(ne);y[_+T*p+v]=oe[f+T]}this.#l(g,y);let E=y.length*4;return{ptr:g,sizeBytes:E,numFrames:m,numChannels:p,sampleRate:h.sampleRate}})}async prepareEmpty(e){let{bufnum:t,numFrames:r,numChannels:i=1,sampleRate:o=null}=e;if(this.#u(t),!Number.isFinite(r)||r<=0)throw new Error(`/b_alloc requires a positive number of frames (got ${r})`);if(!Number.isFinite(i)||i<=0)throw new Error(`/b_alloc requires a positive channel count (got ${i})`);let a=Math.floor(r),l=Math.floor(i);return this.#E(t,5e3,async()=>{let c=a*l+(this.GUARD_BEFORE+this.GUARD_AFTER)*l,u=this.#y(c),h=new Float32Array(c);this.#l(u,h);let f=h.length*4;return{ptr:u,sizeBytes:f,numFrames:a,numChannels:l,sampleRate:o||this.#a.sampleRate}})}#g(e,t){return!e||e.length===0?Array.from({length:t},(r,i)=>i):(e.forEach(r=>{if(!Number.isInteger(r)||r<0||r>=t)throw new Error(`Channel ${r} is out of range (file has ${t} channels)`)}),e)}#y(e){let t=e*4,r=this.#n.malloc(t);if(r===0){let i=this.#n.stats(),o=((i.available||0)/(1024*1024)).toFixed(2),a=((i.total||0)/(1024*1024)).toFixed(2),l=(t/(1024*1024)).toFixed(2);throw new Error(`Buffer pool allocation failed: requested ${l}MB, available ${o}MB of ${a}MB total`)}return r}#l(e,t){new Float32Array(this.#c,e,t.length).set(t)}#d(e,t,r){return new Promise((i,o)=>{let a=setTimeout(()=>{this.#e.delete(e),o(new Error(`Buffer ${t} allocation timeout (${r}ms)`))},r);this.#e.set(e,{resolve:i,reject:o,timeout:a})})}#f(e,t){let r=crypto.randomUUID(),i=this.#d(r,e,t);return{uuid:r,allocationComplete:i}}async#h(e){let t=this.#o.get(e)||Promise.resolve(),r,i=new Promise(o=>{r=o});return this.#o.set(e,t.then(()=>i)),await t,()=>{r&&(r(),r=null),this.#o.get(e)===i&&this.#o.delete(e)}}#A(e,t,r,i,o){let a=this.#t.get(e),l={ptr:t,size:r,pendingToken:i,pendingPromise:o,previousAllocation:a?{ptr:a.ptr,size:a.size}:null};return this.#t.set(e,l),l}async#s(e){let t=this.#t.get(e);if(t&&t.pendingToken&&t.pendingPromise)try{await t.pendingPromise}catch{}}#p(e,t,r){return!r||typeof r.then!="function"?(this.#S(e,t,!0),Promise.resolve()):r.then(i=>(this.#S(e,t,!0),i)).catch(i=>{throw this.#S(e,t,!1),i})}#S(e,t,r){let i=this.#t.get(e);if(!i||i.pendingToken!==t)return;let o=i.previousAllocation;if(r){i.pendingToken=null,i.pendingPromise=null,i.previousAllocation=null,o?.ptr&&this.#n.free(o.ptr);return}i.ptr&&this.#n.free(i.ptr),i.pendingPromise=null,o?.ptr?this.#t.set(e,{ptr:o.ptr,size:o.size,pendingToken:null,previousAllocation:null}):this.#t.delete(e)}handleBufferFreed(e){let t=e[0],r=e[1],i=this.#t.get(t);if(!i){typeof r=="number"&&r!==0&&this.#n.free(r);return}if(typeof r=="number"&&r===i.ptr){this.#n.free(i.ptr),this.#t.delete(t);return}if(typeof r=="number"&&i.previousAllocation&&i.previousAllocation.ptr===r){this.#n.free(r),i.previousAllocation=null;return}this.#n.free(i.ptr),this.#t.delete(t)}handleBufferAllocated(e){let t=e[0],r=e[1],i=this.#e.get(t);i&&(clearTimeout(i.timeout),i.resolve({bufnum:r}),this.#e.delete(t))}allocate(e){let t=e*4,r=this.#n.malloc(t);if(r===0){let i=this.#n.stats(),o=((i.available||0)/(1024*1024)).toFixed(2),a=((i.total||0)/(1024*1024)).toFixed(2),l=(t/(1024*1024)).toFixed(2);console.error(`[BufferManager] Allocation failed: requested ${l}MB, available ${o}MB of ${a}MB total`)}return r}free(e){return this.#n.free(e)}getView(e,t){return new Float32Array(this.#c,e,t)}getStats(){return this.#n.stats()}getDiagnostics(){let e=this.#n.stats(),t=0,r=0;for(let i of this.#t.values())i&&(t+=i.size||0,i.pendingToken&&r++);return{active:this.#t.size,pending:r,bytesActive:t,pool:{total:this.#r,available:e.available||0,freeBytes:e.free?.size||0,freeBlocks:e.free?.count||0,usedBytes:e.used?.size||0,usedBlocks:e.used?.count||0}}}destroy(){for(let[e,t]of this.#e.entries())clearTimeout(t.timeout),t.reject(new Error("BufferManager destroyed"));this.#e.clear();for(let[e,t]of this.#t.entries())t.ptr&&this.#n.free(t.ptr);this.#t.clear(),this.#o.clear()}};var j={totalPages:1280,ringBufferReserved:3145728,bufferPoolOffset:19922944,bufferPoolSize:63963136,get totalMemory(){return this.bufferPoolOffset+this.bufferPoolSize},get wasmHeapSize(){return this.bufferPoolOffset-this.ringBufferReserved}};var J={numBuffers:1024,maxNodes:1024,maxGraphDefs:1024,maxWireBufs:64,numAudioBusChannels:128,numInputBusChannels:0,numOutputBusChannels:2,numControlBusChannels:4096,bufLength:128,realTimeMemorySize:8192,numRGens:64,realTime:!1,memoryLocking:!1,loadGraphDefs:0,preferredSampleRate:0,verbosity:0};function Ee(s,e,t=0){for(let r=0;r<=t;r++)if(Atomics.compareExchange(s,e,0,1)===0)return!0;return!1}function ge(s,e){Atomics.store(s,e,0)}function X({atomicView:s,dataView:e,uint8View:t,bufferConstants:r,ringBufferBase:i,controlIndices:o,oscMessage:a,maxSpins:l=0}){let c=a.length,u=r.MESSAGE_HEADER_SIZE+c;if(u>r.IN_BUFFER_SIZE-r.MESSAGE_HEADER_SIZE||!Ee(s,o.IN_WRITE_LOCK,l))return!1;try{let h=Atomics.load(s,o.IN_HEAD),f=Atomics.load(s,o.IN_TAIL);if((r.IN_BUFFER_SIZE-1-h+f)%r.IN_BUFFER_SIZE<u)return!1;let m=Atomics.add(s,o.IN_SEQUENCE,1),d=r.IN_BUFFER_SIZE-h;if(u>d){let S=new Uint8Array(r.MESSAGE_HEADER_SIZE),g=new DataView(S.buffer);g.setUint32(0,r.MESSAGE_MAGIC,!0),g.setUint32(4,u,!0),g.setUint32(8,m,!0),g.setUint32(12,0,!0);let y=i+r.IN_BUFFER_START+h,_=i+r.IN_BUFFER_START;if(d>=r.MESSAGE_HEADER_SIZE){t.set(S,y);let E=d-r.MESSAGE_HEADER_SIZE;t.set(a.subarray(0,E),y+r.MESSAGE_HEADER_SIZE),t.set(a.subarray(E),_)}else{t.set(S.subarray(0,d),y),t.set(S.subarray(d),_);let E=r.MESSAGE_HEADER_SIZE-d;t.set(a,_+E)}}else{let S=i+r.IN_BUFFER_START+h;e.setUint32(S,r.MESSAGE_MAGIC,!0),e.setUint32(S+4,u,!0),e.setUint32(S+8,m,!0),e.setUint32(S+12,0,!0),t.set(a,S+r.MESSAGE_HEADER_SIZE)}Atomics.load(s,o.IN_HEAD);let p=(h+u)%r.IN_BUFFER_SIZE;return Atomics.store(s,o.IN_HEAD,p),!0}finally{ge(s,o.IN_WRITE_LOCK)}}var se=class s{static osc={encode:e=>R.writePacket(e),decode:(e,t={metadata:!1})=>R.readPacket(e,t)};#i;#a;#c;#n;#r;#t;#e;#o;#w;#u;#E;#g;#y;#l;#d;#f;#h;#A;#s;#p;#S;#L;#C;#T;#b;#B;#z;#O=null;#k=!1;#$=100;constructor(e={}){if(this.#l=!1,this.#d=!1,this.#f=null,this.#h={},this.#A=null,this.#r=null,this.#t=null,this.#e=null,this.#i=null,this.#a=null,this.#c=null,this.#o=null,this.loadedSynthDefs=new Set,this.onOSC=null,this.onMessage=null,this.onMessageSent=null,this.onDebugMessage=null,this.onInitialized=null,this.onError=null,this.onMetricsUpdate=null,!e.workerBaseURL||!e.wasmBaseURL)throw new Error(`SuperSonic requires workerBaseURL and wasmBaseURL options. Example:
new SuperSonic({
  workerBaseURL: "/supersonic/workers/",
  wasmBaseURL: "/supersonic/wasm/"
})`);let t=e.workerBaseURL,r=e.wasmBaseURL,i={...J,...e.scsynthOptions};this.#s={wasmUrl:e.wasmUrl||r+"scsynth-nrt.wasm",wasmBaseURL:r,workletUrl:e.workletUrl||t+"scsynth_audio_worklet.js",workerBaseURL:t,development:!1,audioContextOptions:{latencyHint:"interactive",sampleRate:48e3},memory:j,worldOptions:i,preschedulerCapacity:e.preschedulerCapacity||65536},this.#g=e.sampleBaseURL||null,this.#y=e.synthdefBaseURL||null,this.bootStats={initStartTime:null,initDuration:null}}get initialized(){return this.#l}get initializing(){return this.#d}async init(e={}){if(!this.#l)return this.#f?this.#f:(this.#f=this.#Y(e),this.#f)}async#Y(e){this.#s={...this.#s,...e,audioContextOptions:{...this.#s.audioContextOptions,...e.audioContextOptions||{}}},this.#d=!0,this.bootStats.initStartTime=performance.now();try{this.#Q(),this.#K(),this.#j(),this.#J();let t=await this.#ee();await this.#te(t),await this.#re(),this.#ne(),this.#V(),this.#ie()}catch(t){throw this.#d=!1,this.#f=null,console.error("[SuperSonic] Initialization failed:",t),this.onError&&this.onError(t),t}}getMetrics(){return this.#W()}setMetricsInterval(e){this.#$=e,this.#V()}stopMetricsPolling(){this.#P()}getTree(){if(!this.#l||!this.#r||!this.#e)return{nodeCount:0,version:0,nodes:[]};let e=this.#e,t=this.#t+e.NODE_TREE_START,r=new Uint32Array(this.#r,t,2),i=r[0],o=r[1],a=t+e.NODE_TREE_HEADER_SIZE,l=e.NODE_TREE_MAX_NODES,c=e.NODE_TREE_ENTRY_SIZE,u=e.NODE_TREE_DEF_NAME_SIZE,h=new DataView(this.#r,a,l*c),f=new TextDecoder("utf-8"),w=[],m=0;for(let d=0;d<l&&m<i;d++){let p=d*c,S=h.getInt32(p,!0);if(S===-1)continue;m++;let g=a+p+24,y=new Uint8Array(this.#r,g,u),_=new Uint8Array(u);_.set(y);let E=_.indexOf(0);E===-1&&(E=u);let T=f.decode(_.subarray(0,E));w.push({id:S,parentId:h.getInt32(p+4,!0),isGroup:h.getInt32(p+8,!0)===1,prevId:h.getInt32(p+12,!0),nextId:h.getInt32(p+16,!0),headId:h.getInt32(p+20,!0),defName:T})}return{nodeCount:i,version:o,nodes:w}}get bufferConstants(){return this.#e}get ringBufferBase(){return this.#t}get sharedBuffer(){return this.#r}startCapture(){if(!this.#l||!this.#r||!this.#e)throw new Error("SuperSonic not initialized");let e=this.#e,t=this.#t+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#r,t,4);Atomics.store(r,1,0),Atomics.store(r,0,1)}stopCapture(){if(!this.#l||!this.#r||!this.#e)throw new Error("SuperSonic not initialized");let e=this.#e,t=this.#t+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#r,t,4);Atomics.store(r,0,0);let i=Atomics.load(r,1),o=r[2],a=r[3],l=t+e.AUDIO_CAPTURE_HEADER_SIZE,c=new Float32Array(this.#r,l,i*a),u=new Float32Array(i),h=a>1?new Float32Array(i):null;for(let f=0;f<i;f++)u[f]=c[f*a],h&&(h[f]=c[f*a+1]);return{sampleRate:o,channels:a,frames:i,left:u,right:h}}isCaptureEnabled(){if(!this.#l||!this.#r||!this.#e)return!1;let e=this.#e,t=this.#t+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#r,t,1);return Atomics.load(r,0)===1}getCaptureFrames(){if(!this.#l||!this.#r||!this.#e)return 0;let e=this.#e,t=this.#t+e.AUDIO_CAPTURE_START,r=new Uint32Array(this.#r,t,2);return Atomics.load(r,1)}getMaxCaptureDuration(){if(!this.#e)return 0;let e=this.#e;return e.AUDIO_CAPTURE_FRAMES/(e.AUDIO_CAPTURE_SAMPLE_RATE||48e3)}async send(e,...t){if(this.#I("send OSC messages"),e==="/d_load"||e==="/d_loadDir")throw new Error(`${e} is not supported in SuperSonic (no filesystem). Use loadSynthDef() or send /d_recv with synthdef bytes instead.`);if(e==="/b_read"||e==="/b_readChannel")throw new Error(`${e} is not supported in SuperSonic (no filesystem). Use loadSample() to load audio into a buffer.`);if(e==="/b_write"||e==="/b_close")throw new Error(`${e} is not supported in SuperSonic (no filesystem). Writing audio files is not available in the browser.`);if(e==="/clearSched")throw new Error("/clearSched is not supported in SuperSonic. Bundle scheduling works differently in the browser AudioWorklet environment.");if(e==="/dumpOSC")throw new Error("/dumpOSC is not supported in SuperSonic. Use browser developer tools to inspect OSC messages.");if(e==="/error")throw new Error("/error is not supported in SuperSonic. Error notifications are always enabled.");if(e==="/d_free")for(let a of t)typeof a=="string"&&this.loadedSynthDefs.delete(a);else e==="/d_freeAll"&&this.loadedSynthDefs.clear();let r=t.map(a=>{if(typeof a=="string")return{type:"s",value:a};if(typeof a=="number")return{type:Number.isInteger(a)?"i":"f",value:a};if(a instanceof Uint8Array||a instanceof ArrayBuffer)return{type:"b",value:a instanceof ArrayBuffer?new Uint8Array(a):a};throw new Error(`Unsupported argument type: ${typeof a}`)}),i={address:e,args:r},o=s.osc.encode(i);return this.sendOSC(o)}async sendOSC(e,t={}){this.#I("send OSC data");let r=this.#we(e),i=await this.#Ee(r);if(this.#D("mainMessagesSent"),this.#D("mainBytesSent",i.length),this.onMessageSent&&this.onMessageSent(i),this.#ue(i)&&this.#he(i)){this.#D("preschedulerBypassed");return}let o=this.#e?.scheduler_slot_size;if(o&&i.length>o)throw new Error(`OSC bundle too large to schedule (${i.length} > ${o} bytes). Use immediate timestamp (0 or 1) for large messages, or reduce bundle size.`);let a=this.#Re(i),l={...t};a&&(l.audioTimeS=a.audioTimeS,l.currentTimeS=a.currentTimeS),this.#c.send(i,l)}get audioContext(){return this.#i}get workletNode(){return this.#a}get osc(){return this.#c}async loadSynthDef(e){if(!this.#l)throw new Error("SuperSonic not initialized. Call init() first.");let t;if(this.#H(e))t=e;else{if(!this.#y)throw new Error("synthdefBaseURL not configured. Either provide a full path or set synthdefBaseURL in constructor options.");t=`${this.#y}${e}.scsyndef`}try{let r=await fetch(t);if(!r.ok)throw new Error(`Failed to load synthdef from ${t}: ${r.status} ${r.statusText}`);let i=await r.arrayBuffer(),o=new Uint8Array(i);return await this.send("/d_recv",o),{name:this.#me(t),size:o.length}}catch(r){throw console.error("[SuperSonic] Failed to load synthdef:",r),r}}async loadSynthDefs(e){if(!this.#l)throw new Error("SuperSonic not initialized. Call init() first.");let t={};await Promise.all(e.map(async i=>{try{await this.loadSynthDef(i),t[i]={success:!0}}catch(o){console.error(`[SuperSonic] Failed to load ${i}:`,o),t[i]={success:!1,error:o.message}}}));let r=Object.values(t).filter(i=>i.success).length;return t}async loadSample(e,t,r=0,i=0){this.#I("load samples");let o;if(this.#H(t))o=t;else{if(!this.#g)throw new Error("sampleBaseURL not configured. Either provide a full path or set sampleBaseURL in constructor options.");o=`${this.#g}${t}`}let a=await this.#U().prepareFromFile({bufnum:e,path:o,startFrame:r,numFrames:i});return await this.send("/b_allocPtr",e,a.ptr,a.numFrames,a.numChannels,a.sampleRate,a.uuid),a.allocationComplete}async sync(e=Math.floor(Math.random()*2147483647)){if(!this.#l)throw new Error("SuperSonic not initialized. Call init() first.");let t=new Promise((r,i)=>{let o=setTimeout(()=>{this.#u&&this.#u.delete(e),i(new Error("Timeout waiting for /synced response"))},1e4),a=l=>{clearTimeout(o),this.#u.delete(e),r()};this.#u||(this.#u=new Map),this.#u.set(e,a)});await this.send("/sync",e),await t}getInfo(){return this.#I("get info"),{sampleRate:this.#i.sampleRate,numBuffers:this.#s.worldOptions.numBuffers,totalMemory:this.#s.memory.totalMemory,wasmHeapSize:this.#s.memory.wasmHeapSize,bufferPoolSize:this.#s.memory.bufferPoolSize,bootTimeMs:this.bootStats.initDuration,capabilities:{...this.#h},version:this.#A}}async destroy(){this.#G(),this.#P(),this.#u?.clear(),this.#u=null,this.#c&&(this.#c.terminate(),this.#c=null),this.#a&&(this.#a.disconnect(),this.#a=null),this.#i&&(await this.#i.close(),this.#i=null),this.#o&&(this.#o.destroy(),this.#o=null),this.#r=null,this.#l=!1,this.loadedSynthDefs.clear()}#Q(){this.#h={audioWorklet:typeof AudioWorklet<"u",sharedArrayBuffer:typeof SharedArrayBuffer<"u",crossOriginIsolated:window.crossOriginIsolated===!0,atomics:typeof Atomics<"u",webWorker:typeof Worker<"u"};let t=["audioWorklet","sharedArrayBuffer","crossOriginIsolated","atomics","webWorker"].filter(r=>!this.#h[r]);if(t.length>0){let r=new Error(`Missing required features: ${t.join(", ")}`);throw this.#h.crossOriginIsolated||(this.#h.sharedArrayBuffer?r.message+=`

SharedArrayBuffer is available but cross-origin isolation is not enabled. Please ensure COOP and COEP headers are set correctly:
  Cross-Origin-Opener-Policy: same-origin
  Cross-Origin-Embedder-Policy: require-corp`:r.message+=`

SharedArrayBuffer is not available. This may be due to:
1. Missing COOP/COEP headers
2. Browser doesn't support SharedArrayBuffer
3. Browser security settings`),r}return this.#h}#K(){let e=this.#s.memory;this.#n=new WebAssembly.Memory({initial:e.totalPages,maximum:e.totalPages,shared:!0}),this.#r=this.#n.buffer}#j(){return this.#i=new AudioContext(this.#s.audioContextOptions),this.#i}#J(){this.#o=new k({audioContext:this.#i,sharedBuffer:this.#r,bufferPoolConfig:{start:this.#s.memory.bufferPoolOffset,size:this.#s.memory.bufferPoolSize},sampleBaseURL:this.#g,maxBuffers:this.#s.worldOptions.numBuffers})}async#X(){let e=this.#s.wasmBaseURL+"manifest.json";try{let t=await fetch(e);if(!t.ok)return;let r=await t.json();this.#s.wasmUrl=this.#s.wasmBaseURL+r.wasmFile}catch{}}async#ee(){this.#s.development&&await this.#X();let e;try{e=await fetch(this.#s.wasmUrl)}catch(t){throw new Error(`Failed to fetch WASM from ${this.#s.wasmUrl}: ${t.message}`)}if(!e.ok)throw new Error(`Failed to load WASM: ${e.status} ${e.statusText}`);return await e.arrayBuffer()}async#te(e){await this.#i.audioWorklet.addModule(this.#s.workletUrl),this.#a=new AudioWorkletNode(this.#i,"scsynth-processor",{numberOfInputs:0,numberOfOutputs:1,outputChannelCount:[2]}),this.#a.connect(this.#i.destination),this.#a.port.postMessage({type:"init",sharedBuffer:this.#r}),this.#a.port.postMessage({type:"loadWasm",wasmBytes:e,wasmMemory:this.#n,worldOptions:this.#s.worldOptions,sampleRate:this.#i.sampleRate}),await this.#se()}async#re(){this.#c=new O(this.#s.workerBaseURL),this.#c.onRawOSC(e=>{this.onOSC&&this.onOSC(e)}),this.#c.onParsedOSC(e=>{if(e.address==="/supersonic/buffer/freed")this.#o?.handleBufferFreed(e.args);else if(e.address==="/supersonic/buffer/allocated")this.#o?.handleBufferAllocated(e.args);else if(e.address==="/supersonic/synthdef/loaded"){let t=e.args[0];t&&this.loadedSynthDefs.add(t)}else if(e.address==="/synced"&&e.args.length>0){let t=e.args[0];this.#u&&this.#u.has(t)&&this.#u.get(t)(e)}this.onMessage&&this.onMessage(e)}),this.#c.onDebugMessage(e=>{this.onDebugMessage&&this.onDebugMessage(e)}),this.#c.onError((e,t)=>{console.error(`[SuperSonic] ${t} error:`,e),this.onError&&this.onError(new Error(`${t}: ${e}`))}),await this.#c.init(this.#r,this.#t,this.#e,{preschedulerCapacity:this.#s.preschedulerCapacity})}#ie(){this.#l=!0,this.#d=!1,this.bootStats.initDuration=performance.now()-this.bootStats.initStartTime,this.onInitialized&&this.onInitialized({capabilities:this.#h,bootStats:this.bootStats})}#se(){return new Promise((e,t)=>{let r=setTimeout(()=>{t(new Error("AudioWorklet initialization timeout"))},5e3),i=async o=>{if(o.data.type!=="debug"){if(o.data.type==="error"){console.error("[AudioWorklet] Error:",o.data.error),clearTimeout(r),this.#a.port.removeEventListener("message",i),t(new Error(o.data.error||"AudioWorklet error"));return}o.data.type==="initialized"&&(clearTimeout(r),this.#a.port.removeEventListener("message",i),o.data.success?(o.data.ringBufferBase!==void 0?this.#t=o.data.ringBufferBase:console.warn("[SuperSonic] Warning: ringBufferBase not provided by worklet"),o.data.bufferConstants!==void 0?(this.#e=o.data.bufferConstants,this.#le(),await this.#fe(),this.#Se()):console.warn("[SuperSonic] Warning: bufferConstants not provided by worklet"),e()):t(new Error(o.data.error||"AudioWorklet initialization failed")))}};this.#a.port.addEventListener("message",i),this.#a.port.start()})}#ne(){this.#a.port.onmessage=e=>{let{data:t}=e;switch(t.type){case"error":console.error("[Worklet] Error:",t.error),t.diagnostics&&(console.error("[Worklet] Diagnostics:",t.diagnostics),console.table(t.diagnostics)),this.onError&&this.onError(new Error(t.error));break;case"process_debug":break;case"debug":break;case"version":this.#A=t.version;break}}}#oe(){if(!this.#T)return null;let e=this.#T;return{workletProcessCount:e[0],workletMessagesProcessed:e[1],workletMessagesDropped:e[2],workletSchedulerDepth:e[3],workletSchedulerMax:e[4],workletSchedulerDropped:e[5],workletSequenceGaps:e[24],preschedulerPending:e[6],preschedulerPeak:e[7],preschedulerSent:e[8],preschedulerRetriesSucceeded:e[9],preschedulerRetriesFailed:e[10],preschedulerBundlesScheduled:e[11],preschedulerEventsCancelled:e[12],preschedulerTotalDispatches:e[13],preschedulerMessagesRetried:e[14],preschedulerRetryQueueSize:e[15],preschedulerRetryQueueMax:e[16],preschedulerBypassed:e[25],oscInMessagesReceived:e[17],oscInMessagesDropped:e[18],oscInBytesReceived:e[19],debugMessagesReceived:e[20],debugBytesReceived:e[21],mainMessagesSent:e[22],mainBytesSent:e[23]}}#ae(){if(!this.#p||!this.#e||!this.#t)return null;let e=this.#t+this.#e.CONTROL_START,t=this.#p,r=Atomics.load(t,(e+0)/4),i=Atomics.load(t,(e+4)/4),o=Atomics.load(t,(e+8)/4),a=Atomics.load(t,(e+12)/4),l=Atomics.load(t,(e+16)/4),c=Atomics.load(t,(e+20)/4),u=(r-i+this.#e.IN_BUFFER_SIZE)%this.#e.IN_BUFFER_SIZE,h=(o-a+this.#e.OUT_BUFFER_SIZE)%this.#e.OUT_BUFFER_SIZE,f=(l-c+this.#e.DEBUG_BUFFER_SIZE)%this.#e.DEBUG_BUFFER_SIZE;return{inBufferUsed:{bytes:u,percentage:u/this.#e.IN_BUFFER_SIZE*100},outBufferUsed:{bytes:h,percentage:h/this.#e.OUT_BUFFER_SIZE*100},debugBufferUsed:{bytes:f,percentage:f/this.#e.DEBUG_BUFFER_SIZE*100}}}#D(e,t=1){if(!this.#T)return;let r={mainMessagesSent:22,mainBytesSent:23,preschedulerBypassed:25};Atomics.add(this.#T,r[e],t)}#W(){let e=performance.now(),t=this.#oe()||{},r=this.#ae();if(r&&Object.assign(t,r),t.driftOffsetMs=this.#pe(),t.audioContextState=this.#i?.state||"unknown",this.#o){let o=this.#o.getStats();t.bufferPoolUsedBytes=o.used.size,t.bufferPoolAvailableBytes=o.available,t.bufferPoolAllocations=o.used.count}t.loadedSynthDefs=this.loadedSynthDefs?.size||0;let i=performance.now()-e;return i>1&&console.warn(`[SuperSonic] Slow metrics gathering: ${i.toFixed(2)}ms`),t}#V(){this.#P();let e=this.#$;this.#O=setInterval(()=>{if(this.onMetricsUpdate){if(this.#k){console.warn(`[SuperSonic] Metrics gathering took >${e}ms, skipping this interval`);return}this.#k=!0;try{let t=this.#W();this.onMetricsUpdate(t)}catch(t){console.error("[SuperSonic] Metrics gathering failed:",t)}finally{this.#k=!1}}},e)}#P(){this.#O&&(clearInterval(this.#O),this.#O=null)}#I(e="perform this operation"){if(!this.#l)throw new Error(`SuperSonic not initialized. Call init() before attempting to ${e}.`)}#le(){if(!this.#r||!this.#t||!this.#e){console.warn("[SuperSonic] Cannot initialize direct write views - missing buffer info");return}this.#p=new Int32Array(this.#r),this.#S=new DataView(this.#r),this.#L=new Uint8Array(this.#r);let e=this.#t+this.#e.METRICS_START;this.#T=new Uint32Array(this.#r,e,this.#e.METRICS_SIZE/4),this.#b=new Float64Array(this.#r,this.#t+this.#e.NTP_START_TIME_START,1),this.#B=new Int32Array(this.#r,this.#t+this.#e.DRIFT_OFFSET_START,1),this.#z=new Int32Array(this.#r,this.#t+this.#e.GLOBAL_OFFSET_START,1);let t=this.#e.CONTROL_START;this.#C={IN_HEAD:(this.#t+t+0)/4,IN_TAIL:(this.#t+t+4)/4,IN_SEQUENCE:(this.#t+t+24)/4,IN_WRITE_LOCK:(this.#t+t+40)/4}}#ce(e){return e.length>=8&&e[0]===35}#ue(e){if(!this.#ce(e)||e.length<16)return!0;let t=new DataView(e.buffer,e.byteOffset,e.byteLength),r=t.getUint32(8,!1),i=t.getUint32(12,!1);if(r===0&&(i===0||i===1)||!this.#i||!this.#b)return!0;let o=this.#b[0],a=this.#i.currentTime+o;return r+i/4294967296-a<.2}#he(e){return!this.#p||!this.#C?!1:X({atomicView:this.#p,dataView:this.#S,uint8View:this.#L,bufferConstants:this.#e,ringBufferBase:this.#t,controlIndices:this.#C,oscMessage:e})}#H(e){return e.includes("/")||e.includes("://")}#Oe(){return this.#o?.getStats()}async#fe(){if(!this.#e||!this.#i)return;let e;for(;e=this.#i.getOutputTimestamp(),!(e.contextTime>0);)await new Promise(o=>setTimeout(o,50));let i=(performance.timeOrigin+e.performanceTime)/1e3+2208988800-e.contextTime;this.#b[0]=i,this.#E=i}#de(){if(!this.#e||!this.#i||this.#E===void 0)return;let e=this.#i.getOutputTimestamp(),o=(performance.timeOrigin+e.performanceTime)/1e3+2208988800-this.#E-e.contextTime,a=Math.round(o*1e3);Atomics.store(this.#B,0,a)}#pe(){return this.#B?Atomics.load(this.#B,0):0}#Se(){this.#G(),this.#w=setInterval(()=>{this.#de()},15e3)}#G(){this.#w&&(clearInterval(this.#w),this.#w=null)}#me(e){return!e||typeof e!="string"?null:(e.split("/").filter(Boolean).pop()||e).replace(/\.scsyndef$/i,"")}#we(e){if(e instanceof Uint8Array)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);throw new Error("oscData must be ArrayBuffer or Uint8Array")}async#Ee(e){let t={metadata:!0,unpackSingleArgs:!1};try{let r=s.osc.decode(e,t),{packet:i,changed:o}=await this.#Z(r);return o?s.osc.encode(i):e}catch(r){throw console.error("[SuperSonic] Failed to prepare OSC packet:",r),r}}async#Z(e){if(e&&e.address){let{message:t,changed:r}=await this.#ge(e);return{packet:t,changed:r}}if(this.#Be(e)){let t=await Promise.all(e.packets.map(o=>this.#Z(o)));if(!t.some(o=>o.changed))return{packet:e,changed:!1};let i=t.map(o=>o.packet);return{packet:{timeTag:e.timeTag,packets:i},changed:!0}}return{packet:e,changed:!1}}async#ge(e){switch(e.address){case"/b_alloc":return{message:await this.#Ae(e),changed:!0};case"/b_allocRead":return{message:await this.#ye(e),changed:!0};case"/b_allocReadChannel":return{message:await this.#_e(e),changed:!0};default:return{message:e,changed:!1}}}async#ye(e){let t=this.#U(),r=this.#v(e.args,0,"/b_allocRead requires a buffer number"),i=this.#q(e.args,1,"/b_allocRead requires a file path"),o=this.#R(e.args,2,0),a=this.#R(e.args,3,0),l=await t.prepareFromFile({bufnum:r,path:i,startFrame:o,numFrames:a});return this.#N(l.allocationComplete,`/b_allocRead ${r}`),this.#x(r,l)}async#_e(e){let t=this.#U(),r=this.#v(e.args,0,"/b_allocReadChannel requires a buffer number"),i=this.#q(e.args,1,"/b_allocReadChannel requires a file path"),o=this.#R(e.args,2,0),a=this.#R(e.args,3,0),l=[];for(let u=4;u<(e.args?.length||0)&&this.#F(e.args[u]);u++)l.push(Math.floor(this.#_(e.args[u])));let c=await t.prepareFromFile({bufnum:r,path:i,startFrame:o,numFrames:a,channels:l.length>0?l:null});return this.#N(c.allocationComplete,`/b_allocReadChannel ${r}`),this.#x(r,c)}async#Ae(e){let t=this.#U(),r=this.#v(e.args,0,"/b_alloc requires a buffer number"),i=this.#v(e.args,1,"/b_alloc requires a frame count"),o=2,a=1,l=this.#i?.sampleRate||44100;this.#F(this.#m(e.args,o))&&(a=Math.max(1,this.#R(e.args,o,1)),o++),this.#m(e.args,o)?.type==="b"&&o++,this.#F(this.#m(e.args,o))&&(l=this.#_(this.#m(e.args,o)));let c=await t.prepareEmpty({bufnum:r,numFrames:i,numChannels:a,sampleRate:l});return this.#N(c.allocationComplete,`/b_alloc ${r}`),this.#x(r,c)}#x(e,t){return{address:"/b_allocPtr",args:[this.#M(e),this.#M(t.ptr),this.#M(t.numFrames),this.#M(t.numChannels),this.#Te(t.sampleRate),this.#be(t.uuid)]}}#M(e){return{type:"i",value:Math.floor(e)}}#Te(e){return{type:"f",value:e}}#be(e){return{type:"s",value:String(e)}}#m(e,t){if(Array.isArray(e))return e[t]}#_(e){if(e!=null)return typeof e=="object"&&Object.prototype.hasOwnProperty.call(e,"value")?e.value:e}#v(e,t,r){let i=this.#_(this.#m(e,t));if(!Number.isFinite(i))throw new Error(r);return Math.floor(i)}#R(e,t,r=0){let i=this.#_(this.#m(e,t));return Number.isFinite(i)?Math.floor(i):r}#q(e,t,r){let i=this.#_(this.#m(e,t));if(typeof i!="string")throw new Error(r);return i}#F(e){if(!e)return!1;let t=this.#_(e);return Number.isFinite(t)}#N(e,t){!e||typeof e.catch!="function"||e.catch(r=>{console.error(`[SuperSonic] ${t} allocation failed:`,r)})}#U(){if(!this.#o)throw new Error("Buffer manager not ready. Call init() before issuing buffer commands.");return this.#o}#Be(e){return e&&e.timeTag!==void 0&&Array.isArray(e.packets)}#Re(e){if(e.length<16||String.fromCharCode.apply(null,e.slice(0,8))!=="#bundle\0")return null;let r=this.#b[0];if(r===0)return console.warn("[SuperSonic] NTP start time not yet initialized"),null;let o=Atomics.load(this.#B,0)/1e3,l=Atomics.load(this.#z,0)/1e3,c=r+o+l,u=new DataView(e.buffer,e.byteOffset),h=u.getUint32(8,!1),f=u.getUint32(12,!1);if(h===0&&(f===0||f===1))return null;let m=h+f/4294967296-c,d=this.#i.currentTime;return{audioTimeS:m,currentTimeS:d}}};export{se as SuperSonic};
/*! osc.js 2.4.5, Copyright 2024 Colin Clark | github.com/colinbdclark/osc.js */
